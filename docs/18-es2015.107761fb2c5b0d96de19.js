(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{wFkS:function(t,i,e){"use strict";e.r(i),e.d(i,"VisitorsListPageModule",(function(){return R}));var s=e("SVse"),c=e("s7LF"),o=e("sZkV"),n=e("iInd"),r=e("z6cu"),a=e("JIr8"),l=e("lJxs"),u=e("vkgz"),b=e("XNiG"),h=e("zx2A");class d{constructor(t,i){this.notifier=t,this.source=i}call(t,i){return i.subscribe(new g(t,this.notifier,this.source))}}class g extends h.b{constructor(t,i,e){super(t),this.notifier=i,this.source=e}error(t){if(!this.isStopped){let e=this.errors,s=this.retries,c=this.retriesSubscription;if(s)this.errors=void 0,this.retriesSubscription=void 0;else{e=new b.a;try{const{notifier:t}=this;s=t(e)}catch(i){return super.error(i)}c=Object(h.c)(s,new h.a(this))}this._unsubscribeAndRecycle(),this.errors=e,this.retries=s,this.retriesSubscription=c,e.next(t)}}_unsubscribe(){const{errors:t,retriesSubscription:i}=this;t&&(t.unsubscribe(),this.errors=void 0),i&&(i.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0}notifyNext(){const{_unsubscribe:t}=this;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=t,this.source.subscribe(this)}}var p=e("D0XW"),f=e("7o/Q"),v=e("WMd4");class k{constructor(t,i){this.delay=t,this.scheduler=i}call(t,i){return i.subscribe(new O(t,this.delay,this.scheduler))}}class O extends f.a{constructor(t,i,e){super(t),this.delay=i,this.scheduler=e,this.queue=[],this.active=!1,this.errored=!1}static dispatch(t){const i=t.source,e=i.queue,s=t.scheduler,c=t.destination;for(;e.length>0&&e[0].time-s.now()<=0;)e.shift().notification.observe(c);if(e.length>0){const i=Math.max(0,e[0].time-s.now());this.schedule(t,i)}else this.unsubscribe(),i.active=!1}_schedule(t){this.active=!0,this.destination.add(t.schedule(O.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))}scheduleNotification(t){if(!0===this.errored)return;const i=this.scheduler,e=new m(i.now()+this.delay,t);this.queue.push(e),!1===this.active&&this._schedule(i)}_next(t){this.scheduleNotification(v.a.createNext(t))}_error(t){this.errored=!0,this.queue=[],this.destination.error(t),this.unsubscribe()}_complete(){this.scheduleNotification(v.a.createComplete()),this.unsubscribe()}}class m{constructor(t,i){this.time=t,this.notification=i}}var P=e("eIep"),C=e("IzEk"),_=e("pLZG"),y=e("nYR2"),w=e("UXun"),I=e("wZ+X"),j=e("8Y7J"),V=e("9Ku7"),U=e("apZm"),A=e("lyr6");function S(t,i){if(1&t&&(j.Pb(0,"ion-text",6),j.sc(1),j.cc(2,"json"),j.Ob()),2&t){const t=j.bc();j.Ab(1),j.uc(" ",j.dc(2,1,t.errors),"\n")}}function D(t,i){if(1&t){const t=j.Qb();j.Nb(0),j.Pb(1,"ion-fab-button",7),j.Xb("click",(function(){return j.nc(t),j.bc().clickMissionControlNonBlockingSwitchNotificationToastFade()})),j.Lb(2,"ion-icon",8),j.Lb(3,"ion-icon",9),j.Ob(),j.Pb(4,"ion-fab-list",10),j.Pb(5,"ion-fab-button",11),j.Pb(6,"ion-icon",12),j.Xb("click",(function(i){j.nc(t);const e=j.bc();return e.clickBulkCheckOut(i,e.placeUUID)})),j.Ob(),j.Ob(),j.Ob(),j.Mb()}if(2&t){const t=i.ngIf;j.Ab(1),j.hc("disabled",0===t)}}function L(t,i){if(1&t&&(j.Nb(0),j.Pb(1,"ion-label"),j.Pb(2,"h2"),j.sc(3),j.Ob(),j.Pb(4,"h3"),j.Lb(5,"ion-icon",13),j.sc(6),j.Ob(),j.Ob(),j.Mb()),2&t){const t=i.$implicit;j.Ab(3),j.uc(" ",t.place_name," "),j.Ab(3),j.uc(" ",t.visits_aggregate.aggregate.count," visitors ")}}function x(t,i){if(1&t&&(j.Nb(0),j.qc(1,L,7,2,"ng-container",4),j.cc(2,"async"),j.Mb()),2&t){const t=j.bc(2);j.Ab(1),j.hc("ngForOf",j.dc(2,1,t.place))}}function N(t,i){if(1&t&&(j.Pb(0,"ion-list-header"),j.qc(1,x,3,3,"ng-container",3),j.cc(2,"async"),j.Ob()),2&t){const t=j.bc();j.Ab(1),j.hc("ngIf",null!==j.dc(2,1,t.place))}}function q(t,i){if(1&t){const t=j.Qb();j.Pb(0,"ion-item-option",18),j.Xb("click",(function(i){j.nc(t);const e=j.bc().$implicit;return j.bc().clickCheckOut(i,e.visitor.visitor_uuid,e.checked_in_at)})),j.sc(1," Check out "),j.Ob()}}function T(t,i){if(1&t&&(j.Pb(0,"ion-item-sliding"),j.Pb(1,"ion-item-options"),j.qc(2,q,2,0,"ion-item-option",14),j.Ob(),j.Pb(3,"ion-item",15),j.Pb(4,"ion-label",16),j.Pb(5,"span",17),j.sc(6),j.cc(7,"date"),j.cc(8,"date"),j.Ob(),j.Pb(9,"h2"),j.sc(10),j.Ob(),j.Pb(11,"h3"),j.sc(12),j.Ob(),j.Ob(),j.Ob(),j.Ob()),2&t){const t=i.$implicit;j.Ab(2),j.hc("ngIf",!t.checked_out_at),j.Ab(2),j.ic("color",t.checked_out_at?"success":"warning"),j.Ab(2),j.vc(" ",j.ec(7,8,t.checked_in_at,"EEEE HH:mm"),"\u2013",j.ec(8,11,t.checked_out_at,"HH:mm")," "),j.Ab(4),j.vc(" ",t.visitor.visitor_first_name," ",t.visitor.visitor_last_name," "),j.Ab(2),j.vc(" ",t.visitor.visitor_phone," ",t.visitor.visitor_email," ")}}const B=[{path:"",component:(()=>{class t{constructor(t,i,e,s,c,o){this.activatedRoute=t,this.router=i,this.toastController=e,this.authenticationService=s,this.checkInOutService=c,this.placeAdminService=o,this.missionControlCoverClickedUnlocked=!1,this.errors=[],this.placeUUID=t.snapshot.paramMap.get("placeUUID"),console.log("VisitorsListPage -> constructor -> this.placeUUID",this.placeUUID);const n=o.getVisitorsByPlaceUUID(this.placeUUID);this.placeVisitorsResult=n;const b=n.pipe(Object(a.a)((t,i)=>{var e;console.error("VisitorsListPage -> err",t),console.error("VisitorsListPage -> caught",i);const s=t;console.error("VisitorsListPage -> apolloError",s);const c=null===(e=s.extensions)||void 0===e?void 0:e.code;return this.presentToast(`Real-time subscription out of sync. Authorisation expired; Please try refreshing or signing in again to administrate your COVIDSafe registry. <br/> ${c}<br/> Reloading soon`),Object(r.a)(t)}),Object(l.a)(t=>(console.log("VisitorsListPage -> interceptResult",t),t)),Object(u.a)(t=>{console.log("VisitorsListPage -> placeVisitorsResult",t)}),(h=t=>(console.log("VisitorsListPage -> retryWhen errors",t),t.pipe(function(t,i=p.a){var e;const s=(e=t)instanceof Date&&!isNaN(+e)?+t-i.now():Math.abs(t);return t=>t.lift(new k(s,i))}(5e3),Object(u.a)(t=>{console.log("VisitorsListPage -> triggerSideEffectBigRefresh",t),location.reload()}),Object(P.a)(t=>o.getVisitorsByPlaceUUID(this.placeUUID)),Object(C.a)(2),Object(u.a)(t=>{}))),t=>t.lift(new d(h,t))),Object(u.a)(t=>{var i;0===(null===(i=t.data)||void 0===i?void 0:i.place.length)&&(this.presentToast("No places found. Have you activated the correct Place link? <br/>Check account setup or email info@singletouchdigital.com.au to find out more"),this.router.navigate(["sign-in"]))}),Object(_.a)(t=>{var i,e;return void 0!==(null===(e=null===(i=t.data)||void 0===i?void 0:i.place)||void 0===e?void 0:e[0])}),Object(l.a)(t=>t.data.place),Object(u.a)(t=>{console.log("VisitorsListPage -> greatSuccess",t)}),Object(y.a)(()=>{console.log("VisitorsListPage -> completed")}));var h;this.place=b;const g=b.pipe(Object(l.a)(t=>t[0].visits));this.visits=g,this.visitsPendingCheckOut=this.visits.pipe(Object(l.a)(t=>t.filter(t=>Object(I.c)(t.checked_out_at)))),this.countVisitsPendingCheckOut=this.visitsPendingCheckOut.pipe(Object(l.a)(({length:t})=>t),Object(w.a)(1))}ngOnInit(){}clickCheckOut(t,i,e){if(console.log("clickCheckOut -> event",t),void 0===i||void 0===e)return;const s=this.checkInOutService.updateCheckOutVisitor(this.placeUUID,i,e);console.log("VisitorsListPage -> clickCheckOut -> checkedOutObs",s),s.subscribe(({data:t,errors:i,context:e,extensions:s})=>{var c;console.log("clickCheckOut -> data",t,i,e,s);const o=new Date(null===(c=null==t?void 0:t.update_visit_by_pk)||void 0===c?void 0:c.checked_out_at);console.log("VisitorsListPage -> clickCheckOut -> checkedOutDateTime",o)})}getCountPendingCheckoutVisitors(){}filterRemainingPendingCheckOutVisitors(){}clickMissionControlNonBlockingSwitchNotificationToastFade(){this.countVisitsPendingCheckOut.pipe(Object(C.a)(1)).subscribe(t=>{this.missionControlCoverClickedUnlocked=!this.missionControlCoverClickedUnlocked,this.missionControlCoverClickedUnlocked&&this.presentToast(`Are you sure you want to check out remaining ${t} visitors?<br/>(for end of day reconciliation)`,800,"passiveToast")})}clickBulkCheckOut(t,i){this.placeAdminService.updateBulkCheckOut(i).pipe(Object(u.a)(t=>{console.log("bulkCheckOut",t)}),Object(_.a)(t=>{var i,e,s,c;return null!==(null===(e=null===(i=t.data)||void 0===i?void 0:i.update_visit)||void 0===e?void 0:e.affected_rows)&&void 0!==(null===(c=null===(s=t.data)||void 0===s?void 0:s.update_visit)||void 0===c?void 0:c.affected_rows)}),Object(C.a)(1),Object(l.a)(t=>t.data.update_visit),Object(u.a)(t=>{const i=t.affected_rows>0?`Thank you for keeping us a COVIDSafe Place<br/>Successfully checked out ${t.affected_rows} visitors`:"Thank you for keeping us a COVIDSafe Place<br/>Visitors already checked out";console.log("clickBulkCheckOut -> successfulEndOfDayBulkCheckOut",t,i),this.presentToast(i)})).subscribe()}presentToast(t="loading",i=3500,e,s){this.toastController.create({message:t,duration:i,animated:!0,cssClass:e,color:s,translucent:!0}).then(t=>t.present()).then(()=>{console.log("Toast presented "+t)})}}return t.\u0275fac=function(i){return new(i||t)(j.Kb(n.a),j.Kb(n.g),j.Kb(o.J),j.Kb(V.a),j.Kb(U.a),j.Kb(A.a))},t.\u0275cmp=j.Eb({type:t,selectors:[["app-visitors-list"]],decls:19,vars:18,consts:[["color","cobaltblue"],["color","danger",4,"ngIf"],["horizontal","start","vertical","bottom","slot","fixed","size","large"],[4,"ngIf"],[4,"ngFor","ngForOf"],["color","light","hidden",""],["color","danger"],["color","cobaltbluemonochrome",3,"disabled","click"],["name","list-outline","size","large"],["name","log-out-outline","size","small"],["side","end"],["color","warning"],["name","log-out-outline","color","","size","large",3,"click"],["name","people"],["color","success","button","",3,"click",4,"ngIf"],["button",""],[3,"color"],[2,"float","right"],["color","success","button","",3,"click"]],template:function(t,i){1&t&&(j.Pb(0,"ion-header"),j.Pb(1,"ion-toolbar",0),j.Pb(2,"ion-title"),j.sc(3," List COVIDSafe check ins \u2705 | Place visitors "),j.Ob(),j.Ob(),j.Ob(),j.qc(4,S,3,3,"ion-text",1),j.Pb(5,"ion-fab",2),j.qc(6,D,7,1,"ng-container",3),j.cc(7,"async"),j.Ob(),j.Pb(8,"ion-content"),j.Pb(9,"ion-list"),j.qc(10,N,3,3,"ion-list-header",3),j.qc(11,T,13,14,"ion-item-sliding",4),j.cc(12,"async"),j.Ob(),j.Pb(13,"ion-text",5),j.sc(14),j.cc(15,"json"),j.cc(16,"async"),j.cc(17,"json"),j.cc(18,"async"),j.Ob(),j.Ob()),2&t&&(j.Ab(4),j.hc("ngIf",i.errors.length>0),j.Ab(2),j.hc("ngIf",j.dc(7,6,i.countVisitsPendingCheckOut)),j.Ab(4),j.hc("ngIf",i.place),j.Ab(1),j.hc("ngForOf",j.dc(12,8,i.visits)),j.Ab(3),j.vc(" 1 ",j.dc(15,10,j.dc(16,12,i.place))," 2 ",j.dc(17,14,j.dc(18,16,i.visits))," "))},directives:[o.n,o.C,o.B,s.m,o.j,o.i,o.w,s.l,o.A,o.k,o.o,o.l,o.x,o.v,o.u,o.t,o.q,o.s],pipes:[s.b,s.g,s.e],styles:["ion-icon[_ngcontent-%COMP%]{vertical-align:middle}"]}),t})()}];let M=(()=>{class t{}return t.\u0275mod=j.Ib({type:t}),t.\u0275inj=j.Hb({factory:function(i){return new(i||t)},imports:[[n.i.forChild(B)],n.i]}),t})(),R=(()=>{class t{}return t.\u0275mod=j.Ib({type:t}),t.\u0275inj=j.Hb({factory:function(i){return new(i||t)},imports:[[s.c,c.g,o.D,M]]}),t})()}}]);