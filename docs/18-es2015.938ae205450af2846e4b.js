(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{wFkS:function(t,i,e){"use strict";e.r(i),e.d(i,"VisitorsListPageModule",(function(){return z}));var s=e("SVse"),c=e("s7LF"),o=e("sZkV"),n=e("iInd"),r=e("z6cu"),a=e("JIr8"),l=e("lJxs"),u=e("vkgz"),b=e("XNiG"),h=e("zx2A");class d{constructor(t,i){this.notifier=t,this.source=i}call(t,i){return i.subscribe(new g(t,this.notifier,this.source))}}class g extends h.b{constructor(t,i,e){super(t),this.notifier=i,this.source=e}error(t){if(!this.isStopped){let e=this.errors,s=this.retries,c=this.retriesSubscription;if(s)this.errors=void 0,this.retriesSubscription=void 0;else{e=new b.a;try{const{notifier:t}=this;s=t(e)}catch(i){return super.error(i)}c=Object(h.c)(s,new h.a(this))}this._unsubscribeAndRecycle(),this.errors=e,this.retries=s,this.retriesSubscription=c,e.next(t)}}_unsubscribe(){const{errors:t,retriesSubscription:i}=this;t&&(t.unsubscribe(),this.errors=void 0),i&&(i.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0}notifyNext(){const{_unsubscribe:t}=this;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=t,this.source.subscribe(this)}}var p=e("Kj3r"),f=e("D0XW"),v=e("7o/Q"),k=e("WMd4");class O{constructor(t,i){this.delay=t,this.scheduler=i}call(t,i){return i.subscribe(new m(t,this.delay,this.scheduler))}}class m extends v.a{constructor(t,i,e){super(t),this.delay=i,this.scheduler=e,this.queue=[],this.active=!1,this.errored=!1}static dispatch(t){const i=t.source,e=i.queue,s=t.scheduler,c=t.destination;for(;e.length>0&&e[0].time-s.now()<=0;)e.shift().notification.observe(c);if(e.length>0){const i=Math.max(0,e[0].time-s.now());this.schedule(t,i)}else this.unsubscribe(),i.active=!1}_schedule(t){this.active=!0,this.destination.add(t.schedule(m.dispatch,this.delay,{source:this,destination:this.destination,scheduler:t}))}scheduleNotification(t){if(!0===this.errored)return;const i=this.scheduler,e=new P(i.now()+this.delay,t);this.queue.push(e),!1===this.active&&this._schedule(i)}_next(t){this.scheduleNotification(k.a.createNext(t))}_error(t){this.errored=!0,this.queue=[],this.destination.error(t),this.unsubscribe()}_complete(){this.scheduleNotification(k.a.createComplete()),this.unsubscribe()}}class P{constructor(t,i){this.time=t,this.notification=i}}var C=e("eIep"),_=e("IzEk"),y=e("pLZG"),j=e("nYR2"),w=e("UXun"),I=e("wZ+X"),V=e("8Y7J"),U=e("9Ku7"),A=e("apZm"),S=e("lyr6");function D(t,i){if(1&t&&(V.Pb(0,"ion-text",6),V.sc(1),V.cc(2,"json"),V.Ob()),2&t){const t=V.bc();V.Ab(1),V.uc(" ",V.dc(2,1,t.errors),"\n")}}function L(t,i){if(1&t){const t=V.Qb();V.Nb(0),V.Pb(1,"ion-fab-button",7),V.Xb("click",(function(){return V.nc(t),V.bc().clickMissionControlNonBlockingSwitchNotificationToastFade()})),V.Lb(2,"ion-icon",8),V.Lb(3,"ion-icon",9),V.Ob(),V.Pb(4,"ion-fab-list",10),V.Pb(5,"ion-fab-button",11),V.Pb(6,"ion-icon",12),V.Xb("click",(function(i){V.nc(t);const e=V.bc();return e.clickBulkCheckOut(i,e.placeUUID)})),V.Ob(),V.Ob(),V.Ob(),V.Mb()}if(2&t){const t=i.ngIf;V.Ab(1),V.hc("disabled",0===t)}}function x(t,i){if(1&t&&(V.Nb(0),V.Pb(1,"ion-label"),V.Pb(2,"h2"),V.sc(3),V.Ob(),V.Pb(4,"h3"),V.Lb(5,"ion-icon",13),V.sc(6),V.Ob(),V.Ob(),V.Mb()),2&t){const t=i.$implicit;V.Ab(3),V.uc(" ",t.place_name," "),V.Ab(3),V.uc(" ",t.visits_aggregate.aggregate.count," visitors ")}}function N(t,i){if(1&t&&(V.Nb(0),V.qc(1,x,7,2,"ng-container",4),V.cc(2,"async"),V.Mb()),2&t){const t=V.bc(2);V.Ab(1),V.hc("ngForOf",V.dc(2,1,t.place))}}function q(t,i){if(1&t&&(V.Pb(0,"ion-list-header"),V.qc(1,N,3,3,"ng-container",3),V.cc(2,"async"),V.Ob()),2&t){const t=V.bc();V.Ab(1),V.hc("ngIf",null!==V.dc(2,1,t.place))}}function T(t,i){if(1&t){const t=V.Qb();V.Pb(0,"ion-item-option",18),V.Xb("click",(function(i){V.nc(t);const e=V.bc().$implicit;return V.bc().clickCheckOut(i,e.visitor.visitor_uuid,e.checked_in_at)})),V.sc(1," Check out "),V.Ob()}}function B(t,i){if(1&t&&(V.Pb(0,"ion-item-sliding"),V.Pb(1,"ion-item-options"),V.qc(2,T,2,0,"ion-item-option",14),V.Ob(),V.Pb(3,"ion-item",15),V.Pb(4,"ion-label",16),V.Pb(5,"span",17),V.sc(6),V.cc(7,"date"),V.cc(8,"date"),V.Ob(),V.Pb(9,"h2"),V.sc(10),V.Ob(),V.Pb(11,"h3"),V.sc(12),V.Ob(),V.Ob(),V.Ob(),V.Ob()),2&t){const t=i.$implicit;V.Ab(2),V.hc("ngIf",!t.checked_out_at),V.Ab(2),V.ic("color",t.checked_out_at?"success":"warning"),V.Ab(2),V.vc(" ",V.ec(7,8,t.checked_in_at,"EEEE HH:mm"),"\u2013",V.ec(8,11,t.checked_out_at,"HH:mm")," "),V.Ab(4),V.vc(" ",t.visitor.visitor_first_name," ",t.visitor.visitor_last_name," "),V.Ab(2),V.vc(" ",t.visitor.visitor_phone," ",t.visitor.visitor_email," ")}}const M=[{path:"",component:(()=>{class t{constructor(t,i,e,s,c,o){this.activatedRoute=t,this.router=i,this.toastController=e,this.authenticationService=s,this.checkInOutService=c,this.placeAdminService=o,this.missionControlCoverClickedUnlocked=!1,this.errors=[],this.placeUUID=t.snapshot.paramMap.get("placeUUID"),console.log("VisitorsListPage -> constructor -> this.placeUUID",this.placeUUID);const n=o.getVisitorsByPlaceUUID(this.placeUUID);this.placeVisitorsResult=n;const b=n.pipe(Object(a.a)((t,i)=>{var e;console.error("VisitorsListPage -> err",t),console.error("VisitorsListPage -> caught",i);const s=t;console.error("VisitorsListPage -> apolloError",s);const c=null===(e=s.extensions)||void 0===e?void 0:e.code;return this.presentToast(`Real-time subscription out of sync. Authorisation expired; Please try refreshing or signing in again to administrate your COVIDSafe registry. <br/> ${c}<br/> Reloading soon`),Object(r.a)(t)}),Object(l.a)(t=>(console.log("VisitorsListPage -> interceptResult",t),t)),Object(u.a)(t=>{console.log("VisitorsListPage -> placeVisitorsResult",t)}),(h=t=>(console.log("VisitorsListPage -> retryWhen errors",t),t.pipe(Object(p.a)(500),function(t,i=f.a){var e;const s=(e=t)instanceof Date&&!isNaN(+e)?+t-i.now():Math.abs(t);return t=>t.lift(new O(s,i))}(5e3),Object(u.a)(t=>{console.log("VisitorsListPage -> triggerSideEffectBigRefresh",t),location.reload()}),Object(C.a)(t=>o.getVisitorsByPlaceUUID(this.placeUUID)),Object(_.a)(1),Object(u.a)(t=>{}))),t=>t.lift(new d(h,t))),Object(u.a)(t=>{var i;0===(null===(i=t.data)||void 0===i?void 0:i.place.length)&&(this.presentToast("No places found. Have you activated the correct Place link? <br/>Check account setup or email info@singletouchdigital.com.au to find out more"),this.router.navigate(["sign-in"]))}),Object(y.a)(t=>{var i,e;return void 0!==(null===(e=null===(i=t.data)||void 0===i?void 0:i.place)||void 0===e?void 0:e[0])}),Object(l.a)(t=>t.data.place),Object(u.a)(t=>{console.log("VisitorsListPage -> greatSuccess",t)}),Object(j.a)(()=>{console.log("VisitorsListPage -> completed")}));var h;this.place=b;const g=b.pipe(Object(l.a)(t=>t[0].visits));this.visits=g,this.visitsPendingCheckOut=this.visits.pipe(Object(l.a)(t=>t.filter(t=>Object(I.c)(t.checked_out_at)))),this.countVisitsPendingCheckOut=this.visitsPendingCheckOut.pipe(Object(l.a)(({length:t})=>t),Object(w.a)(1))}ngOnInit(){}clickCheckOut(t,i,e){if(console.log("clickCheckOut -> event",t),void 0===i||void 0===e)return;const s=this.checkInOutService.updateCheckOutVisitor(this.placeUUID,i,e);console.log("VisitorsListPage -> clickCheckOut -> checkedOutObs",s),s.subscribe(({data:t,errors:i,context:e,extensions:s})=>{var c;console.log("clickCheckOut -> data",t,i,e,s);const o=new Date(null===(c=null==t?void 0:t.update_visit_by_pk)||void 0===c?void 0:c.checked_out_at);console.log("VisitorsListPage -> clickCheckOut -> checkedOutDateTime",o)})}getCountPendingCheckoutVisitors(){}filterRemainingPendingCheckOutVisitors(){}clickMissionControlNonBlockingSwitchNotificationToastFade(){this.countVisitsPendingCheckOut.pipe(Object(_.a)(1)).subscribe(t=>{this.missionControlCoverClickedUnlocked=!this.missionControlCoverClickedUnlocked,this.missionControlCoverClickedUnlocked&&this.presentToast(`Are you sure you want to check out remaining ${t} visitors?<br/>(for end of day reconciliation)`,800,"passiveToast")})}clickBulkCheckOut(t,i){this.placeAdminService.updateBulkCheckOut(i).pipe(Object(u.a)(t=>{console.log("bulkCheckOut",t)}),Object(y.a)(t=>{var i,e,s,c;return null!==(null===(e=null===(i=t.data)||void 0===i?void 0:i.update_visit)||void 0===e?void 0:e.affected_rows)&&void 0!==(null===(c=null===(s=t.data)||void 0===s?void 0:s.update_visit)||void 0===c?void 0:c.affected_rows)}),Object(_.a)(1),Object(l.a)(t=>t.data.update_visit),Object(u.a)(t=>{const i=t.affected_rows>0?`Thank you for keeping us a COVIDSafe Place<br/>Successfully checked out ${t.affected_rows} visitors`:"Thank you for keeping us a COVIDSafe Place<br/>Visitors already checked out";console.log("clickBulkCheckOut -> successfulEndOfDayBulkCheckOut",t,i),this.presentToast(i)})).subscribe()}presentToast(t="loading",i=3500,e,s){this.toastController.create({message:t,duration:i,animated:!0,cssClass:e,color:s,translucent:!0}).then(t=>t.present()).then(()=>{console.log("Toast presented "+t)})}}return t.\u0275fac=function(i){return new(i||t)(V.Kb(n.a),V.Kb(n.g),V.Kb(o.J),V.Kb(U.a),V.Kb(A.a),V.Kb(S.a))},t.\u0275cmp=V.Eb({type:t,selectors:[["app-visitors-list"]],decls:19,vars:18,consts:[["color","cobaltblue"],["color","danger",4,"ngIf"],["horizontal","start","vertical","bottom","slot","fixed","size","large"],[4,"ngIf"],[4,"ngFor","ngForOf"],["color","light","hidden",""],["color","danger"],["color","cobaltbluemonochrome",3,"disabled","click"],["name","list-outline","size","large"],["name","log-out-outline","size","small"],["side","end"],["color","warning"],["name","log-out-outline","color","","size","large",3,"click"],["name","people"],["color","success","button","",3,"click",4,"ngIf"],["button",""],[3,"color"],[2,"float","right"],["color","success","button","",3,"click"]],template:function(t,i){1&t&&(V.Pb(0,"ion-header"),V.Pb(1,"ion-toolbar",0),V.Pb(2,"ion-title"),V.sc(3," List COVIDSafe check ins \u2705 | Place visitors "),V.Ob(),V.Ob(),V.Ob(),V.qc(4,D,3,3,"ion-text",1),V.Pb(5,"ion-fab",2),V.qc(6,L,7,1,"ng-container",3),V.cc(7,"async"),V.Ob(),V.Pb(8,"ion-content"),V.Pb(9,"ion-list"),V.qc(10,q,3,3,"ion-list-header",3),V.qc(11,B,13,14,"ion-item-sliding",4),V.cc(12,"async"),V.Ob(),V.Pb(13,"ion-text",5),V.sc(14),V.cc(15,"json"),V.cc(16,"async"),V.cc(17,"json"),V.cc(18,"async"),V.Ob(),V.Ob()),2&t&&(V.Ab(4),V.hc("ngIf",i.errors.length>0),V.Ab(2),V.hc("ngIf",V.dc(7,6,i.countVisitsPendingCheckOut)),V.Ab(4),V.hc("ngIf",i.place),V.Ab(1),V.hc("ngForOf",V.dc(12,8,i.visits)),V.Ab(3),V.vc(" 1 ",V.dc(15,10,V.dc(16,12,i.place))," 2 ",V.dc(17,14,V.dc(18,16,i.visits))," "))},directives:[o.n,o.C,o.B,s.m,o.j,o.i,o.w,s.l,o.A,o.k,o.o,o.l,o.x,o.v,o.u,o.t,o.q,o.s],pipes:[s.b,s.g,s.e],styles:["ion-icon[_ngcontent-%COMP%]{vertical-align:middle}"]}),t})()}];let R=(()=>{class t{}return t.\u0275mod=V.Ib({type:t}),t.\u0275inj=V.Hb({factory:function(i){return new(i||t)},imports:[[n.i.forChild(M)],n.i]}),t})(),z=(()=>{class t{}return t.\u0275mod=V.Ib({type:t}),t.\u0275inj=V.Hb({factory:function(i){return new(i||t)},imports:[[s.c,c.g,o.D,R]]}),t})()}}]);